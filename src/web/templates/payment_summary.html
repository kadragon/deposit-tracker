{% extends "base.html" %}

{% block title %}결제 확인 - 공동 결제 시스템{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800">결제 확인</h1>
        {% if store_name %}
        <div class="text-lg text-gray-600">{{ store_name }}</div>
        {% endif %}
    </div>

    <!-- Payment Summary Cards -->
    <div class="space-y-4">
        <h2 class="text-xl font-semibold text-gray-800">결제 요약</h2>
        
        {% for user_payment in user_payments %}
        <div class="bg-white rounded-lg shadow p-6 border {% if user_payment.insufficient_balance %}border-red-200 bg-red-50{% else %}border-gray-200{% endif %}">
            <!-- User Info Header -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-3">
                    <!-- User Avatar -->
                    {% set avatar_colors = [
                        'from-blue-500 to-blue-600',
                        'from-green-500 to-green-600', 
                        'from-purple-500 to-purple-600',
                        'from-red-500 to-red-600',
                        'from-yellow-500 to-yellow-600',
                        'from-pink-500 to-pink-600'
                    ] %}
                    <div class="w-12 h-12 bg-gradient-to-br {{ avatar_colors[loop.index0 % avatar_colors|length] }} rounded-full flex items-center justify-center text-white text-lg font-semibold">
                        {{ user_payment.name[0] if user_payment.name else '?' }}
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">{{ user_payment.name }}</h3>
                        <p class="text-sm text-gray-600">예치금: {{ "{:,}".format(user_payment.deposit) }}원</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-primary">{{ "{:,}".format(user_payment.amount) }}원</div>
                    {% if user_payment.insufficient_balance %}
                    <div class="text-sm text-red-600 font-medium">잔액 부족</div>
                    {% else %}
                    <div class="text-sm text-green-600 font-medium">결제 가능</div>
                    {% endif %}
                </div>
            </div>

            <!-- Payment Method Selection -->
            <div class="border-t pt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">결제 방법</label>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2">
                        <input type="radio" 
                               name="payment_method_{{ user_payment.user_id }}" 
                               value="deposit" 
                               {% if not user_payment.insufficient_balance %}checked{% else %}disabled{% endif %}
                               class="form-radio h-4 w-4 text-primary focus:ring-primary border-gray-300">
                        <span class="text-sm text-gray-700 {% if user_payment.insufficient_balance %}text-gray-400{% endif %}">
                            예치금 결제 
                            {% if user_payment.insufficient_balance %}
                            <span class="text-red-600">({{ "{:,}".format(user_payment.deposit - user_payment.amount) }}원 부족)</span>
                            {% endif %}
                        </span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" 
                               name="payment_method_{{ user_payment.user_id }}" 
                               value="cash" 
                               {% if user_payment.insufficient_balance %}checked{% endif %}
                               class="form-radio h-4 w-4 text-primary focus:ring-primary border-gray-300">
                        <span class="text-sm text-gray-700">현금 결제</span>
                    </label>
                </div>
            </div>

            {% if user_payment.insufficient_balance %}
            <!-- Insufficient Balance Warning -->
            <div class="mt-4 p-3 bg-red-100 border border-red-200 rounded-lg">
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-sm text-red-800 font-medium">
                        예치금이 부족합니다. 현금 결제를 선택하거나 예치금을 충전하세요.
                    </span>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Total Summary -->
    <div class="bg-gray-50 rounded-lg shadow p-6 border-2 border-primary">
        <div class="flex justify-between items-center">
            <h3 class="text-xl font-semibold text-gray-800">전체 결제 금액</h3>
            <div class="text-3xl font-bold text-primary">{{ "{:,}".format(total_amount) }}원</div>
        </div>
        
        {% if insufficient_balance_count > 0 %}
        <div class="mt-3 text-sm text-red-600">
            {{ insufficient_balance_count }}명의 사용자가 예치금 부족으로 현금 결제가 필요합니다.
        </div>
        {% endif %}
    </div>

    <!-- Action Buttons -->
    <div class="flex space-x-4">
        <button onclick="history.back()" 
                class="flex-1 px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">
            뒤로
        </button>
        <button onclick="proceedWithPayment()" 
                class="flex-1 px-6 py-3 bg-primary text-white rounded-lg hover:bg-blue-600 font-medium">
            결제 진행
        </button>
    </div>
</div>

<script>
function proceedWithPayment() {
    // Collect payment method selections
    const paymentMethods = {};
    const userPayments = {{ user_payments|tojson }};
    
    userPayments.forEach(user => {
        const selectedMethod = document.querySelector(`input[name="payment_method_${user.user_id}"]:checked`);
        if (selectedMethod) {
            paymentMethods[user.user_id] = {
                user_id: user.user_id,
                amount: user.amount,
                method: selectedMethod.value
            };
        }
    });
    
    // For now, just show confirmation
    const paymentSummary = Object.values(paymentMethods).map(p => 
        `${p.user_id}: ${p.amount.toLocaleString()}원 (${p.method === 'deposit' ? '예치금' : '현금'})`
    ).join('\n');
    
    if (confirm(`결제를 진행하시겠습니까?\n\n${paymentSummary}`)) {
        alert('결제가 처리되었습니다.');
        // TODO: Submit to payment processing endpoint
    }
}
</script>
{% endblock %}